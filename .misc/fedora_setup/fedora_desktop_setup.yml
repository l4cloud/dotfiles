---
- name: Setup Hyprland Desktop Environment
  hosts: localhost
  connection: local
  become: yes

  vars:
    packages_to_install:
      - hyprland
      - kitty
      - hypridle
      - waybar
      - swww
      - swaync
      - pipewire-utils
      - brightnessctl
      - playerctl
      - grim
      - slurp
      - hyprshot
      - hyprlock
      - wlogout
      - thunar
      - wofi
      - git
      - neovim
      - jq
      - gcc
      - make
      - zlib-devel
      - bzip2
      - bzip2-devel
      - readline-devel
      - sqlite
      - sqlite-devel
      - openssl-devel
      - tk-devel
      - libffi-devel
      - xz-devel
      - ncurses-devel
      - patch
      - unzip
      - curl
      - wget
      - zsh
      - python3-pip
      - tmux
      - htop
      - fastfetch


  tasks:
    - name: Enable RPMFusion free repository
      ansible.builtin.command: dnf install -y https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm
      args:
        creates: /etc/yum.repos.d/rpmfusion-free.repo

    - name: Install DNF packages
      ansible.builtin.dnf:
        name: "{{ packages_to_install }}"
        state: present
        update_cache: yes

    - name: Install flatpak
      ansible.builtin.dnf:
        name: flatpak
        state: present

    - name: Add flathub repository
      ansible.builtin.command: flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
      args:
        creates: /var/lib/flatpak/repo/flathub.flatpakrepo

    - name: Install Obsidian via flatpak
      ansible.builtin.command: flatpak install -y flathub md.obsidian.Obsidian

    - name: Install pulsemixer
      become: no
      ansible.builtin.pip:
        name: pulsemixer
        state: present
        executable: pip3

    - name: Check if Hack Nerd Font is already installed
      ansible.builtin.shell: fc-list | grep -i "hack nerd"
      register: font_check
      ignore_errors: true

    - name: Download Hack Nerd Font
      ansible.builtin.get_url:
        url: https://github.com/ryanoasis/nerd-fonts/releases/download/v3.4.0/Hack.zip
        dest: /tmp/Hack.zip
        timeout: 30
        retries: 3
        delay: 10
      when: font_check.rc != 0

    - name: Unzip Hack Nerd Font
      ansible.builtin.unarchive:
        src: /tmp/Hack.zip
        dest: /usr/share/fonts
        remote_src: yes
      when: font_check.rc != 0

    - name: Update font cache
      ansible.builtin.command: fc-cache -fv
      when: font_check.rc != 0

    - name: Verify Hack Nerd Font is installed
      ansible.builtin.shell: fc-list | grep -i "hack nerd"
      register: final_font_check
      failed_when: final_font_check.rc != 0
